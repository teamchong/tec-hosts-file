name: Retrieve and store private IP from AWS

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  retrieve:
    name: Retrieve
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1

    - name: Retrieve PRD_PRIVATE_IP
      shell: bash
      run: |
        PRD_ARN=$( \
          aws ecs list-tasks \
          --cluster arn:aws:ecs:ap-southeast-1:949519472813:cluster/prd-etg-docker \
          --family prd-marketing-website \
          --desired-status RUNNING \
          --no-paginate \
          --query 'taskArns[0]' \
          --output text \
        )
        [ -z $PRD_ARN ] && exit 1
        PRD_CONTAINER=$( \
          aws ecs describe-tasks \
          --cluster arn:aws:ecs:ap-southeast-1:949519472813:cluster/prd-etg-docker \
          --tasks $PRD_ARN \
          --no-paginate \
          --query 'sort_by(tasks[?lastStatus == `RUNNING` && containerInstanceArn != ``], &version)[-1].containerInstanceArn' \
          --output text \
        )
        [ -z $PRD_CONTAINER ] && exit 1
        PRD_EC2=$( \
          aws ecs describe-container-instances \
          --cluster arn:aws:ecs:ap-southeast-1:949519472813:cluster/prd-etg-docker \
          --container-instances $PRD_CONTAINER \
          --no-paginate \
          --query 'containerInstances[0].ec2InstanceId' \
          --output text \
        )
        [ -z $PRD_EC2 ] && exit 1
        PRD_PRIVATE_IP=$( \
          aws ec2 describe-instances \
          --instance-ids $PRD_EC2 \
          --no-paginate \
          --query 'Reservations[0].Instances[0].PrivateIpAddress' \
          --output text
        )
        [ -z $PRD_PRIVATE_IP ] && exit 1
        echo $PRD_PRIVATE_IP > prd_private_ip.txt
        cat <<EOF > index.html
        $PRD_PRIVATE_IP executivecentre.com www.executivecentre.com executivecentre.com.cn www.executivecentre.com.cn executivecentre.co.kr www.executivecentre.co.kr
        EOF

    - name: Retrieve UAT_PRIVATE_IP
      shell: bash
      run: |
        UAT_ARN=$( \
          aws ecs list-tasks \
          --cluster arn:aws:ecs:ap-southeast-1:949519472813:cluster/uat-etg-docker \
          --family uat-marketing-website \
          --desired-status RUNNING \
          --no-paginate \
          --query 'taskArns[0]' \
          --output text \
        )
        [ -z $UAT_ARN ] && exit 1
        UAT_CONTAINER=$( \
          aws ecs describe-tasks \
          --cluster arn:aws:ecs:ap-southeast-1:949519472813:cluster/uat-etg-docker \
          --tasks $UAT_ARN \
          --no-paginate \
          --query 'sort_by(tasks[?lastStatus == `RUNNING` && containerInstanceArn != ``], &version)[-1].containerInstanceArn' \
          --output text \
        )
        [ -z $UAT_CONTAINER ] && exit 1
        UAT_EC2=$( \
          aws ecs describe-container-instances \
          --cluster arn:aws:ecs:ap-southeast-1:949519472813:cluster/uat-etg-docker \
          --container-instances $UAT_CONTAINER \
          --no-paginate \
          --query 'containerInstances[0].ec2InstanceId' \
          --output text \
        )
        [ -z $UAT_EC2 ] && exit 1
        UAT_PRIVATE_IP=$( \
          aws ec2 describe-instances \
          --instance-ids $UAT_EC2 \
          --no-paginate \
          --query 'Reservations[0].Instances[0].PrivateIpAddress' \
          --output text
        )
        [ -z $UAT_PRIVATE_IP ] && exit 1
        echo $UAT_PRIVATE_IP > uat_private_ip.txt
        cat <<EOF > uat.html
        $UAT_PRIVATE_IP executivecentre.com www.executivecentre.com executivecentre.com.cn www.executivecentre.com.cn executivecentre.co.kr www.executivecentre.co.kr
        EOF

    - name: Git Commit and Push
      uses: actions-x/commit@v2
      with:
        message: autocommit
